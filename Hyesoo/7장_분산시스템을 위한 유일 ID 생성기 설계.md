# 7장 분산시스템을 위한 유일 ID 생성기 설계

분산 시스템에서는 DB도 여러 대이기 때문에 DBMS가 제공하는 auto_increment 속성을 사용하여 유일한 ID를 생성할 수 없다.

## 요구사항 분석

- 유일한 ID
- number only
- 64 bit
- 날짜(시간)에 따른 정렬
- 초당 10,000개의 ID 생성

## 전략 제시

### 다중 마스터 복제

![스크린샷 2024-02-13 14.23.30.png](7%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A1%E1%86%AB%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%8B%E1%85%B2%E1%84%8B%E1%85%B5%E1%86%AF%20ID%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%E1%84%80%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%209bff3c53065d4fd886b4b6574ae55164/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-13_14.23.30.png)

개념

- auto_increment를 그대로 유지하되 DB서버 대수(k)만큼 offset을 두는 전략
- 하나의 디비 서버에서는 해당 오프셋만큼의 ID만 가짐으로써 유일성 보장

장점

- 요구사항의 규모 확장(초당 만개) 문제도 DB 수를 늘림으로써 해결 가능

단점

- 여러 데이터 센터에 대한 확장이 어려움
- ID의 유일성은 보장되나 그 값이 시간 흐름에 맞춰 커지도록 보장할 수는 없음
- 서버 추가/삭제시에 조정이 필요

### UUID

![스크린샷 2024-02-13 14.23.46.png](7%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A1%E1%86%AB%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%8B%E1%85%B2%E1%84%8B%E1%85%B5%E1%86%AF%20ID%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%E1%84%80%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%209bff3c53065d4fd886b4b6574ae55164/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-13_14.23.46.png)

개념

- 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트의 수
- 충돌 가능성이 지극히 낮음이 보장됨
- ex) 09c93e62-50b4-468d-bf8a-c07el040bfb2

장점

- 서버사이의 조율이 필요없는 유일한 값이기 때문에 규모 확장에 아무런 문제가 없음
- 생성이 단순함

단점

- ID가 128비트로 길다
- ID를 시간순으로 정렬할 수 없다
- ID에 숫자아닌 값이 들어갈 수 있다

### 티켓 서버

개념

- auto_increment 기능을 갖춘 데이터베이스 서버(티켓 서버)를 중앙집중형으로 하나만 사용하는 것

장점

- 유일성이 보장되는 숫자로 ID를 생성할 수 있다
- 구현하기 쉽고 중소 규모 어플리케이션에 적합

단점

- SPOF(single point of failure)
- 분산하는 의미가 없을 수 있음(개인적생각)

### 트위터 스노플레이크 접근법

개념

- divide and conquer 전략 차용, 생성해야하는 ID의 구조를 여러 절(section)로 분할하는 것

![스크린샷 2024-02-13 14.27.38.png](7%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A1%E1%86%AB%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%8B%E1%85%B2%E1%84%8B%E1%85%B5%E1%86%AF%20ID%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%E1%84%80%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%209bff3c53065d4fd886b4b6574ae55164/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-13_14.27.38.png)

- sign bit : 음수와 양수 구분
- timstamp bit : 밀리초 단위로 기록됨
- 데이터 센터 ID :  5비트 할당했기때문에 최대 32개의 데이터 센터까지 규모확장 가능
- 서버 ID : 5비트 할당했기때문에 한 데이터 센터당 최대 32개의 서버까지 규모확장 가능
- 일련번호 : 각 서버에서 auto_increment 처럼 사용하는 것으로 타임스탬프를 찍늩 기준인 1 밀리초가 경과할때마다 0으로 초기화됨

## 상세 설계

- 데이터센터ID와 서버ID는 어플리케이션 운영중에 바뀌지 않고 타임스태프와 일련번호가 ID생성기에 의해 만들어지는 값임
- 타임스탬프
    - 해당 시스템 기원 시간으로부터 얼마나 지났는지를 밀리초 단위로 기록한 것
    
    ![스크린샷 2024-02-13 14.38.17.png](7%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A1%E1%86%AB%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%8B%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B1%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%8B%E1%85%B2%E1%84%8B%E1%85%B5%E1%86%AF%20ID%20%E1%84%89%E1%85%A2%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%E1%84%80%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%209bff3c53065d4fd886b4b6574ae55164/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-02-13_14.38.17.png)
    
    - 41비트로 2의 41제곱 → 시간으로 환산하면 69년 동안만 정상동작함
    - 69년 이후에는 오버플로 발생
- 일련번호
    - 타임스탬프가 보장하는 1 밀리초 단위에 동시에 생성 요청이 들어왔을 경우 식별하기 위한 값
    - 어떤 서버가 같은 밀리초 동안 하나 이상의 ID를 만들어 낸 경우에만 0보다 큰 값을 갖게 됨

## 마무리

- 시계동기화(clock synchronization)
    - 하나의 서버가 여러코어에서 실행되거나 여러 서버가 물리적으로 독립된 장비에서 실행되는 경우 시간 자체가 달라질 수 있음
    - NTP(Network Time protocol)
- section 길이 최적화
    - 트위터 스노우플레이크 전략에서 동시성이 낮은 서비스라면 일련번호가 0을 초과하는 경우가 거의 발생하지 않을 수 있음
    - 따라서 일련번호를 줄이고 타임스탬프를 늘리면 더 오래 해당 체계를 사용할 수 있음
- 고가용성
    - 어떻게 고가용성을 보장할 것인지 고민